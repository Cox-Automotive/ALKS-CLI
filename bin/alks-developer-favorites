#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

require('cli-color');
var program   = require('commander'),
    _         = require('underscore'),
    async     = require('async'),
    alks     = require('alks.js'),
    inquirer  = require('inquirer'),
    config    = require('../package.json'),
    Developer = require('../lib/developer'),
    utils     = require('../lib/utils');

program
    .version(config.version)
    .description('configure which accounts are favorites')
    .option('-v, --verbose', 'be verbose')
    .parse(process.argv);

var logger       = 'dev-favorites';

async.waterfall([
    // get developer
    function(callback){
        utils.log(program, logger, 'getting developer');
        Developer.getDeveloper(callback);
    },
    // get auth
    function(developer, callback){
        utils.log(program, logger, 'getting auth');
        Developer.getAuth(program, function(err, auth){
            callback(err, developer, auth);
        });
    },
    function(developer, auth, callback){
        utils.log(program, logger, 'getting alks accounts');

        alks.getAccessToken({
            baseUrl: developer.server,
            refreshToken: auth.token
        }).then(tokenInfo => {
            utils.log(program, logger, 'exchanging for access token');

            let alksCreate = alks.create({
                baseUrl: developer.server,
                accessToken: tokenInfo.accessToken
            });

            alksCreate.getAccounts().then(accounts => {
                utils.log(program, logger, 'getting accounts');

                let accountsSorted = [];

                accounts.forEach((item) => {
                    accountsSorted.push({
                        account: item.account,
                        role: item.role,
                        iam: item.iamKeyActive
                    });
                });

                accountsSorted.sort( (a, b) => (a.account > b.account) ? 1 : -1)
                callback(null, developer, auth, accountsSorted);
            }).catch(error => {
                utils.log(program, logger, 'error getting accounts: ' + error);
                callback(error, developer, auth, null);
            });
        }).catch(error => {
            utils.log(program, logger, 'error exchanging for access token: ' + error);
            callback(error, developer, auth, null);
        });

    },
    function(developer, auth, accounts, callback){
        utils.log(program, logger, 'getting favorite accounts');
        Developer.getFavorites(function(err, data){
            callback(null, developer, auth, accounts, data.favorites);
        });
    }
],
function(err, developer, auth, alksAccounts, favorites){
    var choices  = [],
        deferred = [];

    utils.log(program, logger, 'rendering favorite accounts');
    choices.push(new inquirer.Separator(' = Standard = '));
    _.each(alksAccounts, function(val){
        if(!val.iam){
            var name = [val.account, val.role].join(Developer.getAccountDelim());
            choices.push({
                name: name,
                checked: _.contains(favorites, name)
            });
        }
        else deferred.push(val);
    });

    choices.push(new inquirer.Separator(' = IAM = '));
    _.each(deferred, function(val){
        var name = [val.account, val.role].join(Developer.getAccountDelim());
        choices.push({
            name: name,
            checked: _.contains(favorites, name)
        });
    });

    inquirer.prompt([{
        type: 'checkbox',
        message: 'Select favorites',
        name: 'favorites',
        choices: choices,
        pageSize: 25
    }]).then(function(faves){
        Developer.saveFavorites({accounts: faves}, function(){
            console.log('Favorites have been saved!');

            utils.log(program, logger, 'checking for update');
            utils.checkForUpdate();
            Developer.trackActivity(logger);
        });
    });
});
