#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

const path = require('path');
const clc = require('cli-color');
const _ = require('underscore');
const program = require('commander');
const fuzzy = require('fuzzy');
const utils = require('../lib/utils');
const pkg = require(path.join(__dirname, '../', 'package.json'));

program
  .command('sessions', 'manage aws sessions')
  .command('iam', 'manage iam resources')
  .command('developer', 'developer & account commands')
  .command('server', 'ec2 metadata server')
  .version(pkg.version);

if (process.stdout.isTTY) {
  console.error(clc.whiteBright.bold('ALKS v%s'), pkg.version);
}

program.parse(process.argv);

const commands = _.map(program.commands, '_name');
const requestedCommand = _.head(program.args);

if (!program.args.length) {
  program.help();
} else if (!_.includes(commands, requestedCommand)) {
  const msg = [requestedCommand, ' is not a valid ALKS command.'];
  const suggests = fuzzy.filter(requestedCommand, commands);
  const suggest = suggests.map((sug) => sug.string);

  if (suggest.length) {
    msg.push(clc.white(' Did you mean '));
    msg.push(clc.white.underline(suggest[0]));
    msg.push(clc.white('?'));
  }

  utils.errorAndExit(msg.join(''));
}
