#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

require('async');
var program   = require('commander'),
    clc       = require('cli-color'),
    _         = require('underscore'),
    alks     = require('alks.js'),
    config    = require('../package.json'),
    Iam       = require('../lib/iam'),
    Developer = require('../lib/developer'),
    utils     = require('../lib/utils');

var logger = 'iam-delete';

program
    .version(config.version)
    .description('remove an IAM role')
    .option('-n, --rolename [rolename]', 'the name of the role to delete')
    .option('-a, --account [alksAccount]', 'alks account to use')
    .option('-r, --role [alksRole]', 'alks role to use')
    .option('-F, --favorites', 'filters favorite accounts')
    .option('-v, --verbose', 'be verbose')
    .parse(process.argv);

var roleName    = program.rolename,
    alksAccount = program.account,
    alksRole    = program.role,
    filterFaves = program.favorites || false;

utils.log(program, logger, 'validating role name: ' + roleName);
if(_.isEmpty(roleName)){
    utils.errorAndExit('The role name must be provided.');
}

if(!_.isUndefined(alksAccount) && _.isUndefined(alksRole)){
    utils.log(program, logger, 'trying to extract role from account');
    alksRole = utils.tryToExtractRole(alksAccount);
}

Iam.getIAMKey(program, logger, alksAccount, alksRole, false, filterFaves, function(err, key, developer, auth){
    if(err){
        return utils.errorAndExit(err);
    }

    var data = _.extend({}, developer, key);
    utils.log(program, logger, 'calling api to delete role: ' + roleName);

    alks.getAccessToken({
        baseUrl: data.server,
        refreshToken: auth.token
    }).then(tokenInfo => {
        utils.log(program, logger, 'exchanging for access token');

        let alksCreate = alks.create({
            baseUrl: data.server,
            accessToken: tokenInfo.accessToken
        });

        alksCreate.deleteRole({
            account: data.alksAccount,
            role: data.alksRole,
            roleName: roleName
        }).then((isDeleted) => {

            console.log(clc.white(['The role ', roleName, ' was deleted: ', isDeleted ].join('')));
            utils.log(program, logger, 'checking for updates');
            utils.checkForUpdate();
            Developer.trackActivity(logger);

        }).catch(error => {
            utils.log(program, logger, 'error deleting role: ' + error);
            return utils.errorAndExit(err);
        });
    }).catch(error => {
        utils.log(program, logger, 'error exchanging for access token: ' + error);
        return utils.errorAndExit(err);
    });
});
