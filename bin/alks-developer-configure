#!/usr/bin/env node
'use strict';

process.title = 'ALKS';

let program   = require('commander'),
    clc       = require('cli-color'),
    inquirer  = require('inquirer'),
    async     = require('async'),
    _         = require('underscore'),
    config    = require('../package.json'),
    utils     = require('../lib/utils'),
    Developer = require('../lib/developer');

program
    .version(config.version)
    .description('configures developer')
    .option('-v, --verbose', 'be verbose')
    .parse(process.argv);

let logger = 'dev-config';

function getPrompt(field, data, text, validator, callback){
    utils.getStdErrPrompt()([{
        type: 'input',
        name: field,
        message: text,
        default: function(){
            return data[field];
        },
        validate: validator ? validator : function(val){
            return (!_.isEmpty(val)) ? true : 'Please enter a value for ' + text + '.';
        }
    }]).then(function(answers){
        callback(null, answers[field]);
    });
}

async.waterfall([
    // check for an existing developer
    function(callback){
        utils.log(program, logger, 'getting developer');
        Developer.getDeveloper(callback);
    },
    // ask for server
    function(previousData, callback){
        getPrompt('server', previousData, 'ALKS server', utils.isURL, function(err, server){
            callback(err, previousData, server);
        });
    },
    // ask for username
    function(previousData, server, callback){
        getPrompt('userid', previousData, 'Network Username', null, function(err, userid){
            callback(err, previousData, server, userid);
        });
    },
    // check for existing password
    function(previousData, server, userid, callback){
        utils.log(program, logger, 'getting existing auth');
        Developer.getAuth(program, function(err, auth){
            callback(err, previousData, server, userid, auth);
        });
    },
    function(previousData, server, userid, auth, callback){
        utils.log(program, logger, 'getting existing password');
        Developer.getPasswordFromKeystore(function(password){
            auth.password = password;
            callback(null, previousData, server, userid, auth);
        });
    },
    // ask for password
    function(previousData, server, userid, auth, callback){
        utils.log(program, logger, 'getting password');
        Developer.getPasswordFromPrompt(function(err, password){
            auth.password = password;
            callback(err, previousData, server, userid, auth);
        }, 'Network Password', auth.password);
    },
    // ask if they want to save password
    function(previousData, server, userid, auth, callback){
        inquirer.prompt([
            {
                type: 'confirm',
                name: 'savePassword',
                message: 'Save password',
            }
        ]).then(function(answers){
            callback(null, previousData, server, userid, auth, answers.savePassword);
        });
    },
    // request list of accounts from ALKS
    function(previousData, server, userid, auth, savePassword, callback){
        utils.log(program, logger, 'Getting ALKS accounts');
        let prompt = 'Please select your default ALKS account/role';

        program.auth = auth; // this ensures getALKSAccount() doesnt prompt..
        let opts = {
            prompt: prompt,
            dontDefault: true,
            server: server,
            userid: userid
        };

        Developer.getALKSAccount(program, opts, function(err, data){
            if(err){
                if(err.message.indexOf('No accounts') === -1){
                    return callback(err);
                }
            }

            callback(null, previousData, server, userid, auth, savePassword, data? data.alksAccount : '', data? data.alksRole : '');
        });
    },
    // select output format
    function(previousData, server, userid, auth, savePassword, alksAccount, alksRole, callback){
        utils.log(program, logger, 'Getting output formats');

        let promptData = {
                type: 'list',
                name: 'outputFormat',
                default: previousData.outputFormat,
                message: 'Please select your default output format',
                choices: utils.getOutputValues(),
                pageSize: 10
        };

        utils.getStdErrPrompt()([ promptData ]).then(function(answers){
            callback(null, server, userid, auth, savePassword, alksAccount, alksRole, answers.outputFormat);
        });
    }
], function(err, server, userid, auth, savePassword, alksAccount, alksRole, outputFormat){
    // did any of our steps have issues?
    if(err){
        return utils.errorAndExit('Error configuring developer: ' + err.message);
    }

    let developerPayload = {
        server: server,
        userid: userid,
        password: auth.password,
        savePassword: savePassword,
        alksAccount: alksAccount,
        alksRole: alksRole,
        outputFormat: outputFormat
    };

    // create developer
    utils.log(program, logger, 'saving developer');
    Developer.saveDeveloper(developerPayload, function(err){
        if(err){
            utils.log(program, logger, 'error saving! ' + err.message);
            console.error(clc.red.bold('There was an error updating your developer configuration.'));
        }
        else{
            console.error(clc.white('Your developer configuration has been updated.'));
        }

        utils.log(program, logger, 'checking for update');
        utils.checkForUpdate();
        Developer.trackActivity(logger);
    });
});
